From 5b57d576aa9925aa3d6522b01ae5702b0b55fb6f Mon Sep 17 00:00:00 2001
From: Viktor Hofer <viktor.hofer@microsoft.com>
Date: Tue, 29 Oct 2024 12:52:44 +0100
Subject: [PATCH] Forward NetCoreAppToolCurrentVersion property and fix linker

Backport: https://github.com/dotnet/runtime/pull/109331
Tracking issues: https://github.com/dotnet/runtime/issues/109329 &
                 https://github.com/dotnet/runtime/issues/109335

---
 eng/DotNetBuild.props                         | 2 ++
 src/tools/illink/src/ILLink.Tasks/LinkTask.cs | 4 +++-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/eng/DotNetBuild.props b/eng/DotNetBuild.props
index 0a75f2938bf..4b46ce846af 100644
--- a/eng/DotNetBuild.props
+++ b/eng/DotNetBuild.props
@@ -70,6 +70,8 @@
       <InnerBuildArgs Condition="'$(DotNetBuildMonoAOTEnableLLVM)' != ''">$(InnerBuildArgs) /p:MonoAOTEnableLLVM=$(DotNetBuildMonoAOTEnableLLVM)</InnerBuildArgs>
       <InnerBuildArgs Condition="'$(DotNetBuildMonoBundleLLVMOptimizer)' != ''">$(InnerBuildArgs) /p:MonoBundleLLVMOptimizer=$(DotNetBuildMonoBundleLLVMOptimizer)</InnerBuildArgs>
       <InnerBuildArgs Condition="'$(PgoInstrument)' == 'true'">$(InnerBuildArgs) $(FlagParameterPrefix)pgoinstrument</InnerBuildArgs>
+      <!-- Needed until https://github.com/dotnet/runtime/issues/109329 is fixed. -->
+      <InnerBuildArgs Condition="'$(NetCoreAppToolCurrentVersion)' != ''">$(InnerBuildArgs) /p:NetCoreAppToolCurrentVersion=$(NetCoreAppToolCurrentVersion)</InnerBuildArgs>
 
       <!-- This prop needs to be passed to the inner build manually as the BaseInnerSourceBuildCommand gets overridden above -->
       <InnerBuildArgs Condition="'$(DotNetBuildRepo)' == 'true'">$(InnerBuildArgs) /p:DotNetBuildRepo=true</InnerBuildArgs>
diff --git a/src/tools/illink/src/ILLink.Tasks/LinkTask.cs b/src/tools/illink/src/ILLink.Tasks/LinkTask.cs
index ce24b35de9e..719a740169e 100644
--- a/src/tools/illink/src/ILLink.Tasks/LinkTask.cs
+++ b/src/tools/illink/src/ILLink.Tasks/LinkTask.cs
@@ -269,7 +269,9 @@ public string ILLinkPath {
 				var taskDirectory = Path.GetDirectoryName (Assembly.GetExecutingAssembly ().Location);
 #pragma warning restore IL3000 // Avoid accessing Assembly file path when publishing as a single file
 				// IL Linker always runs on .NET Core, even when using desktop MSBuild to host ILLink.Tasks.
-				_illinkPath = Path.Combine (Path.GetDirectoryName (taskDirectory), "net9.0", "illink.dll");
+
+				// TODO: Avoid the hardcoded TFM value: https://github.com/dotnet/runtime/issues/109335
+				_illinkPath = Path.Combine (Path.GetDirectoryName (taskDirectory), "net10.0", "illink.dll");
 				return _illinkPath;
 			}
 			set => _illinkPath = value;
